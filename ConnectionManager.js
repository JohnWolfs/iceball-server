"use strict";
var UserManager_1 = require('./user/UserManager');
var RoomManager_1 = require('./room/RoomManager');
var ClientEvent = {
    'disconnect': function () {
        var uid = this.user.uid;
        var rid = this.user.rid;
        var room = RoomManager_1.default.Instance.getRoom(rid);
        if (room) {
            RoomManager_1.default.Instance.io.to(rid).emit('game:scores', { scores: room.scoreHelper.getScore(), msg: '你的对手离开了游戏' });
            RoomManager_1.default.Instance.removeRoom(rid);
        }
        UserManager_1.default.Instance.removeUser(uid);
        RoomManager_1.default.Instance.removeFromWaitList(uid);
        console.log('===> [user ' + this.socket.id + '] disconnect');
    },
    'user:login': function (data) {
        this.user.name = data.name;
        this.socket.emit('user:loginSuccess', { uid: this.user.uid, username: data.name });
        console.log('System:  [name: ' + this.user.name + '] log in.');
    },
    'user:ready': function () {
        var rid = this.user.rid;
        var uid = this.user.uid;
        var room = RoomManager_1.default.Instance.getRoom(rid);
        if (room)
            room.getReady(uid);
    },
    'user:ctrl': function (ctrl) {
        var game;
        var rid = this.user.rid;
        var room = RoomManager_1.default.Instance.getRoom(rid);
        if (!room || room.status === 0) {
            this.socket.emit('sys:msg', { msg: 'room not exist' });
            return;
        }
        game = room.game;
        if (game)
            game.addCtrl(ctrl);
        else {
            this.socket.emit('sys:msg', { msg: 'game not exist' });
        }
    },
    'room:match': function () {
        RoomManager_1.default.Instance.addToWaitList(this.user);
    },
    'room:join': function () {
    },
    'room:create': function () {
    },
    'game:scorein': function (data) {
        var rid = this.user.rid;
        var room = RoomManager_1.default.Instance.getRoom(rid);
        switch (data.type) {
            case 'bulletExplosion': {
                room.scoreHelper.scorein(data.id, 'bulletExplosion');
                RoomManager_1.default.Instance.io.to(rid).emit('game:scorein', { id: this.user.uid, scores: room.scoreHelper.getScore(this.user.uid) });
                break;
            }
            case 'ballin': {
                room.scoreHelper.scorein(data.id, 'ballin');
                RoomManager_1.default.Instance.io.to(rid).emit('game:scorein', { id: this.user.uid, scores: room.scoreHelper.getScore(this.user.uid) });
                if (room.scoreHelper.checkWin(data.id)) {
                    RoomManager_1.default.Instance.io.to(rid).emit('game:scores', { scores: room.scoreHelper.getScore() });
                    RoomManager_1.default.Instance.removeRoom(rid);
                }
                break;
            }
        }
    }
};
var ConnectionManager = (function () {
    function ConnectionManager() {
    }
    ConnectionManager.prototype.initSocketEvent = function (socket, user) {
        this.socket = socket;
        this.user = user;
        for (var i in ClientEvent) {
            socket.on(i, ClientEvent[i].bind(this));
        }
    };
    return ConnectionManager;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ConnectionManager;

//# sourceMappingURL=data:application/json;base64,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aEJBLEFBZ0JDLElBQUE7QUFoQkQ7bUNBZ0JDLENBQUEiLCJmaWxlIjoiQ29ubmVjdGlvbk1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVXNlck1hbmFnZXIgZnJvbSAnLi91c2VyL1VzZXJNYW5hZ2VyJztcclxuaW1wb3J0IFJvb21NYW5hZ2VyIGZyb20gJy4vcm9vbS9Sb29tTWFuYWdlcic7XHJcblxyXG4vLyDluKfmm7TmlrDljIVcclxuaW50ZXJmYWNlIEZyYW1lUGFjayB7XHJcbiAgICBrZXlmcmFtZTogbnVtYmVyO1xyXG4gICAgY3RybHM6IEFycmF5PEN0cmw+O1xyXG59XHJcblxyXG4vLyDnlKjmiLfmk43kvZxcclxuaW50ZXJmYWNlIEN0cmwge1xyXG4gICAgaWQ6IHN0cmluZztcclxuICAgIGN0cmw6IHtcclxuICAgICAgYW5nbGU6IG51bWJlcixcclxuICAgICAgcG93ZXI6IG51bWJlcixcclxuICAgICAgYnVsbGV0VHlwZTogc3RyaW5nXHJcbiAgICB9XHJcbn1cclxuXHJcbnZhciBDbGllbnRFdmVudCA9IHtcclxuICAgIFxyXG4gICAgJ2Rpc2Nvbm5lY3QnOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgdWlkID0gdGhpcy51c2VyLnVpZDtcclxuICAgICAgICBsZXQgcmlkID0gdGhpcy51c2VyLnJpZDtcclxuICAgICAgICBsZXQgcm9vbSA9IFJvb21NYW5hZ2VyLkluc3RhbmNlLmdldFJvb20ocmlkKTtcclxuXHJcbiAgICAgICAgLy8g6YCa55+l5YW25LuW546p5a6255So5oi356a75byA5bm25Y+R6YCB5YiG5pWw5pWw5o2uXHJcbiAgICAgICAgaWYocm9vbSkge1xyXG4gICAgICAgICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5pby50byhyaWQpLmVtaXQoJ2dhbWU6c2NvcmVzJywge3Njb3Jlczogcm9vbS5zY29yZUhlbHBlci5nZXRTY29yZSgpLCBtc2c6ICfkvaDnmoTlr7nmiYvnprvlvIDkuobmuLjmiI8nfSk7XHJcbiAgICAgICAgICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLnJlbW92ZVJvb20ocmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8g5riF55CG5q6L55WZ55So5oi35pWw5o2uXHJcbiAgICAgICAgVXNlck1hbmFnZXIuSW5zdGFuY2UucmVtb3ZlVXNlcih1aWQpO1xyXG4gICAgICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLnJlbW92ZUZyb21XYWl0TGlzdCh1aWQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnNvbGUubG9nKCc9PT0+IFt1c2VyICcgKyB0aGlzLnNvY2tldC5pZCArICddIGRpc2Nvbm5lY3QnKTtcclxuICAgIH0sXHJcbiAgICBcclxuICAgIC8vIOS7peeUqOaIt+WQjeeZu+W9lVxyXG4gICAgJ3VzZXI6bG9naW4nOiBmdW5jdGlvbihkYXRhOntuYW1lOnN0cmluZ30pIHtcclxuICAgICAgICB0aGlzLnVzZXIubmFtZSA9IGRhdGEubmFtZTtcclxuICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCd1c2VyOmxvZ2luU3VjY2VzcycsIHt1aWQ6IHRoaXMudXNlci51aWQsIHVzZXJuYW1lOiBkYXRhLm5hbWV9KTtcclxuICAgICAgICBjb25zb2xlLmxvZygnU3lzdGVtOiAgW25hbWU6ICcgKyB0aGlzLnVzZXIubmFtZSArICddIGxvZyBpbi4nKTtcclxuICAgIH0sXHJcbiAgICBcclxuICAgIC8vIOeUqOaIt+WHhuWkh1xyXG4gICAgJ3VzZXI6cmVhZHknOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBsZXQgcmlkID0gdGhpcy51c2VyLnJpZDtcclxuICAgICAgICBsZXQgdWlkID0gdGhpcy51c2VyLnVpZDtcclxuICAgICAgICBsZXQgcm9vbSA9IFJvb21NYW5hZ2VyLkluc3RhbmNlLmdldFJvb20ocmlkKTtcclxuICAgICAgICBcclxuICAgICAgICBpZihyb29tKSByb29tLmdldFJlYWR5KHVpZCk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIOeUqOaIt+aTjeS9nFxyXG4gICAgJ3VzZXI6Y3RybCc6IGZ1bmN0aW9uKGN0cmw6IEN0cmwpIHtcclxuICAgICAgICBsZXQgZ2FtZTtcclxuICAgICAgICBsZXQgcmlkID0gdGhpcy51c2VyLnJpZDtcclxuICAgICAgICBsZXQgcm9vbSA9IFJvb21NYW5hZ2VyLkluc3RhbmNlLmdldFJvb20ocmlkKTtcclxuXHJcbiAgICAgICAgaWYoIXJvb20gfHwgcm9vbS5zdGF0dXMgPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCgnc3lzOm1zZycsIHttc2c6ICdyb29tIG5vdCBleGlzdCd9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZ2FtZSA9IHJvb20uZ2FtZTtcclxuXHJcbiAgICAgICAgaWYoZ2FtZSkgZ2FtZS5hZGRDdHJsKGN0cmwpO1xyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdzeXM6bXNnJywge21zZzogJ2dhbWUgbm90IGV4aXN0J30pO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBcclxuICAgIC8vIOW8gOWni+WMuemFjeWvueaJi1xyXG4gICAgJ3Jvb206bWF0Y2gnOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5hZGRUb1dhaXRMaXN0KHRoaXMudXNlcik7XHJcbiAgICB9LFxyXG4gICAgXHJcbiAgICAvLyDliqDlhaXmiL/pl7RcclxuICAgICdyb29tOmpvaW4nOiBmdW5jdGlvbigpIHtcclxuICAgICAgICBcclxuICAgIH0sXHJcbiAgICBcclxuICAgIC8vIOWIm+W7uuaIv+mXtFxyXG4gICAgJ3Jvb206Y3JlYXRlJzogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgXHJcbiAgICB9LFxyXG5cclxuICAgIC8vIC8vIOWtkOW8ueeIhueCuOW+l+WIhlxyXG4gICAgLy8gJ2dhbWU6ZXhwbG9zaW9uJzogZnVuY3Rpb24oZGF0YToge2lkOiBzdHJpbmd9KSB7XHJcbiAgICAvLyAgICAgbGV0IHJpZCA9IHRoaXMudXNlci5yaWQ7XHJcbiAgICAvLyAgICAgbGV0IHJvb20gPSBSb29tTWFuYWdlci5JbnN0YW5jZS5nZXRSb29tKHJpZCk7XHJcblxyXG4gICAgLy8gICAgIHJvb20uc2NvcmVIZWxwZXIuY2F1c2VFeHBsb3Npb24oZGF0YS5pZCk7XHJcblxyXG4gICAgLy8gICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLmlvLnRvKHJpZCkuZW1pdCgnZ2FtZTpzY29yZWluJywge2lkOiB0aGlzLnVzZXIudWlkLCBzY29yZXM6IHJvb20uc2NvcmVIZWxwZXIuZ2V0U2NvcmUodGhpcy51c2VyLnVpZCl9KTtcclxuICAgIC8vIH0sXHJcblxyXG4gICAgLy8gLy8g6L+b55CD5b6X5YiGXHJcbiAgICAvLyAnZ2FtZTpiYWxsaW4nOiBmdW5jdGlvbihkYXRhOiB7aWQ6IHN0cmluZ30pIHtcclxuICAgIC8vICAgICBsZXQgcmlkID0gdGhpcy51c2VyLnJpZDtcclxuICAgIC8vICAgICBsZXQgcm9vbSA9IFJvb21NYW5hZ2VyLkluc3RhbmNlLmdldFJvb20ocmlkKTtcclxuXHJcbiAgICAvLyAgICAgbGV0IHJlc3VsdCA9IHJvb20uc2NvcmVIZWxwZXIuYmFsbEluKGRhdGEuaWQpO1xyXG5cclxuICAgIC8vICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5pby50byhyaWQpLmVtaXQoJ2dhbWU6c2NvcmVpbicsIHtpZDogdGhpcy51c2VyLnVpZCwgc2NvcmVzOiByb29tLnNjb3JlSGVscGVyLmdldFNjb3JlKHRoaXMudXNlci51aWQpfSk7XHJcblxyXG4gICAgLy8gICAgIGlmKHJlc3VsdCkge1xyXG4gICAgLy8gICAgICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5pby50byhyaWQpLmVtaXQoJ2dhbWU6c2NvcmVzJywge3Njb3Jlczogcm9vbS5zY29yZUhlbHBlci5nZXRTY29yZSgpfSk7XHJcbiAgICAvLyAgICAgICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLnJlbW92ZVJvb20ocmlkKTtcclxuICAgIC8vICAgICB9XHJcbiAgICAvLyB9LFxyXG5cclxuICAgIC8vIOW+l+WIhui/m+i0plxyXG4gICAgJ2dhbWU6c2NvcmVpbic6IGZ1bmN0aW9uKGRhdGE6IHtpZDogc3RyaW5nLCB0eXBlOiBzdHJpbmd9KSB7XHJcbiAgICAgICAgbGV0IHJpZCA9IHRoaXMudXNlci5yaWQ7XHJcbiAgICAgICAgbGV0IHJvb20gPSBSb29tTWFuYWdlci5JbnN0YW5jZS5nZXRSb29tKHJpZCk7XHJcblxyXG4gICAgICAgIHN3aXRjaChkYXRhLnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAnYnVsbGV0RXhwbG9zaW9uJzoge1xyXG4gICAgICAgICAgICAgICAgcm9vbS5zY29yZUhlbHBlci5zY29yZWluKGRhdGEuaWQsICdidWxsZXRFeHBsb3Npb24nKTtcclxuICAgICAgICAgICAgICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLmlvLnRvKHJpZCkuZW1pdCgnZ2FtZTpzY29yZWluJywge2lkOiB0aGlzLnVzZXIudWlkLCBzY29yZXM6IHJvb20uc2NvcmVIZWxwZXIuZ2V0U2NvcmUodGhpcy51c2VyLnVpZCl9KTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2JhbGxpbic6IHtcclxuICAgICAgICAgICAgICAgIHJvb20uc2NvcmVIZWxwZXIuc2NvcmVpbihkYXRhLmlkLCAnYmFsbGluJyk7XHJcbiAgICAgICAgICAgICAgICAvLyBSb29tTWFuYWdlci5JbnN0YW5jZS5pby50byhyaWQpLmVtaXQoJ2dhbWU6YmFsbGRpcmVjdGlvbicsIHtpZDogdGhpcy51c2VyLnVpZCwgZGlyZWN0aW9uOiBNYXRoLnJhbmRvbSgpID4gLjU/IDEgOiAwfSk7XHJcbiAgICAgICAgICAgICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5pby50byhyaWQpLmVtaXQoJ2dhbWU6c2NvcmVpbicsIHtpZDogdGhpcy51c2VyLnVpZCwgc2NvcmVzOiByb29tLnNjb3JlSGVscGVyLmdldFNjb3JlKHRoaXMudXNlci51aWQpfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYocm9vbS5zY29yZUhlbHBlci5jaGVja1dpbihkYXRhLmlkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIFJvb21NYW5hZ2VyLkluc3RhbmNlLmlvLnRvKHJpZCkuZW1pdCgnZ2FtZTpzY29yZXMnLCB7c2NvcmVzOiByb29tLnNjb3JlSGVscGVyLmdldFNjb3JlKCl9KTtcclxuICAgICAgICAgICAgICAgICAgICBSb29tTWFuYWdlci5JbnN0YW5jZS5yZW1vdmVSb29tKHJpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbm5lY3Rpb25NYW5hZ2VyIHtcclxuICAgIHByaXZhdGUgdXNlcjtcclxuICAgIHByaXZhdGUgc29ja2V0O1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIGluaXRTb2NrZXRFdmVudChzb2NrZXQsIHVzZXIpIHtcclxuICAgICAgICB0aGlzLnNvY2tldCA9IHNvY2tldDtcclxuICAgICAgICB0aGlzLnVzZXIgPSB1c2VyO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGZvcihsZXQgaSBpbiBDbGllbnRFdmVudCkge1xyXG4gICAgICAgICAgICBzb2NrZXQub24oaSwgQ2xpZW50RXZlbnRbaV0uYmluZCh0aGlzKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
